@page "/"
@using ApplicantJourney
@inject Logic Logic

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">

            <div class="col-md-3">
                <label class="form-label">Company</label>
                <input class="form-control" @bind="companyFilter" placeholder="Type company name (e.g., Robinhood)" />
                <small class="form-text text-muted">Leave empty to see all companies</small>
            </div>

            <div class="col-md-3">
                <label class="form-label">Job Title</label>
                <input class="form-control" @bind="titleContains" placeholder="Filter by job title" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Location</label>
                <input class="form-control" @bind="locationContains" placeholder="Filter by location" />
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="remoteOnly" @bind="remoteOnly" />
                    <label class="form-check-label" for="remoteOnly">Remote only</label>
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Job type</label>
                <select class="form-select" @bind="jobType">
                    <option value="">(Any)</option>
                    @foreach (var t in Enum.GetValues<JobType>())
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Source</label>
                <select class="form-select" @bind="jobSource">
                    <option value="">(Any)</option>
                    @foreach (var s in Enum.GetValues<JobListingSource>())
                    {
                        <option value="@s">@s</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Posted After</label>
                <input type="date" class="form-control" @bind="postedAfterDateOnly" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Sort by</label>
                <select class="form-select" @bind="sortBy">
                    <option value="date">Date</option>
                    <option value="title">Title</option>
                    <option value="company">Company</option>
                </select>
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sortDesc" @bind="sortDesc" />
                    <label class="form-check-label" for="sortDesc">Descending</label>
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Page</label>
                <input class="form-control" type="number" min="@Constants.DefaultPage" @bind="currentPage" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Page size</label>
                <input class="form-control" type="number" min="@Constants.DefaultPageSize" @bind="pageSize" />
            </div>

            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" @onclick="Apply" disabled="@(loading)">
                    @(loading ? "Loading..." : "Apply Filters")
                </button>
                <button class="btn btn-secondary" @onclick="Refresh" disabled="@(loading)">Refresh</button>
                <button class="btn btn-outline-secondary" @onclick="Clear" disabled="@(loading)">Clear</button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (jobs.Count == 0 && !loading && string.IsNullOrEmpty(errorMessage))
{
    <p>No jobs found.</p>
}
else
{
    <!-- Top section with job count and pagination controls -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <small class="text-muted">
                @totalAvailablePositions positions available - Showing @jobs.Count jobs
                @if (!string.IsNullOrEmpty(companyFilter))
                {
                    <span class="badge bg-info ms-2">Company: @companyFilter</span>
                }
            </small>
        </div>

        <!-- Pagination buttons at top right -->
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" @onclick="PreviousPage" disabled="@(currentPage <= Constants.DefaultPage || loading)">
                Previous
            </button>
            <button class="btn btn-outline-primary btn-sm" @onclick="NextPage" disabled="@(jobs.Count < pageSize || loading)">
                Next
            </button>
        </div>
    </div>

    <ul class="list-group">
        @foreach (var job in jobs)
        {
            var company = CompanyConfiguration.GetCompanyById(job.Company);
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="pe-3 flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>@job.JobTitle</strong>
                                @if (company != null)
                                {
                                    <span class="badge bg-primary ms-2">@company.Name</span>
                                }
                            </div>
                            <small class="text-muted">Posted: @job.JobPostingDate.ToShortDateString()</small>
                        </div>

                        <div class="text-muted mt-1">
                            @job.JobLocation?.PhysicalLocation
                            @if (job.JobLocation?.IsRemote == true)
                            {
                                <span class="badge bg-success ms-1">Remote</span>
                            }
                        </div>

                        <!-- Job description limited to 160 words for better readability -->
                        <div class="mt-2 text-break">
                            @GetLimitedDescription(job.JobDescriptionHtml)
                        </div>

                        <div class="mt-2">
                            <a href="@job.Url" target="_blank" rel="noopener noreferrer" class="small">View Job Posting</a>
                        </div>
                    </div>
                </div>
            </li>
        }
    </ul>

    <!-- Bottom pagination controls -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <small class="text-muted">Page @currentPage</small>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" @onclick="PreviousPage" disabled="@(currentPage <= Constants.DefaultPage || loading)">
                Previous
            </button>
            <button class="btn btn-outline-primary btn-sm" @onclick="NextPage" disabled="@(jobs.Count < pageSize || loading)">
                Next
            </button>
        </div>
    </div>
}

@code {
    private string companyFilter = "";

    private string? titleContains;
    private string? locationContains;
    private bool remoteOnly;
    private JobType? jobType;
    private JobListingSource? jobSource;
    private DateTime? postedAfterDateOnly;

    private string sortBy = "date";
    private bool sortDesc = true;
    private int currentPage = Constants.DefaultPage;
    private int pageSize = Constants.DefaultPageSize;

    private List<JobListing> jobs = new();
    private int totalAvailablePositions = 0;
    private bool loading;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Apply() => await LoadJobs();
    private async Task Refresh() => await LoadJobs();

    private Task Clear()
    {
        companyFilter = "";
        titleContains = null;
        locationContains = null;
        remoteOnly = false;
        jobType = null;
        jobSource = null;
        postedAfterDateOnly = null;

        sortBy = "date";
        sortDesc = true;
        currentPage = Constants.DefaultPage;
        pageSize = Constants.DefaultPageSize;

        return LoadJobs();
    }

    private async Task NextPage()
    {
        // Only navigate to next page if current page has full results
        if (jobs.Count >= pageSize)
        {
            currentPage++;
            await LoadJobs();
        }
    }

    private async Task PreviousPage()
    {
        // Only navigate to previous page if not on first page
        if (currentPage > Constants.DefaultPage)
        {
            currentPage--;
            await LoadJobs();
        }
    }

    private string GetLimitedDescription(string? htmlDescription)
    {
        const int maxWords = 160;

        if (string.IsNullOrWhiteSpace(htmlDescription))
            return string.Empty;

        var plainText = ApplicantJourney.HtmlText.ToPlainText(htmlDescription);

        if (string.IsNullOrWhiteSpace(plainText))
            return string.Empty;

        var words = plainText.Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);

        if (words.Length <= maxWords)
            return plainText;

        return string.Join(" ", words.Take(maxWords)) + "...";
    }

    private string GetBoardToken()
    {
        // Use company filter to find specific board token, otherwise return empty for all companies
        if (!string.IsNullOrWhiteSpace(companyFilter))
        {
            var company = CompanyConfiguration.Companies.FirstOrDefault(company =>
                company.Name.Contains(companyFilter, StringComparison.OrdinalIgnoreCase));
            return company?.BoardToken ?? "";
        }

        return "";
    }

    private async Task LoadJobs()
    {
        errorMessage = null;
        loading = true;
        jobs.Clear();
        totalAvailablePositions = 0;
        StateHasChanged();

        try
        {
            var boardToken = GetBoardToken();
            var (results, totalCount) = await Logic.RunPipelineWithCountAsync(
                boardToken: boardToken ?? string.Empty,
                companyId: 0,
                includeContent: true,
                titleContains: string.IsNullOrWhiteSpace(titleContains) ? null : titleContains,
                locationContains: string.IsNullOrWhiteSpace(locationContains) ? null : locationContains,
                remoteOnly: remoteOnly ? true : null,
                type: jobType,
                source: jobSource,
                postedAfter: postedAfterDateOnly,
                sortBy: sortBy,
                sortDesc: sortDesc,
                page: currentPage,
                pageSize: pageSize
            );

            jobs = results.ToList();
            totalAvailablePositions = totalCount;
        }
        catch (Exception ex)
        {
            errorMessage = $"Could not load jobs: {ex.Message}";
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
}